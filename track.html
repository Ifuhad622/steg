<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Track Shipment - SLNSA</title>
<link rel="stylesheet" href="assets/css/style.css">
<style>
  body { font-family: Arial, sans-serif; background: #f9f9f9; }
  header, footer { text-align: center; padding: 15px; background: #004080; color: #fff; }
  nav a { color: #fff; margin: 0 10px; text-decoration: none; }
  main { max-width: 900px; margin: 20px auto; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  .tracking-form input, .tracking-form select, .tracking-form button { width: 100%; padding: 10px; margin: 5px 0; }
  .tracking-result { display: none; margin-top: 20px; }
  .status { font-weight: bold; }
  .status.pending { color: orange; }
  .status.in-transit { color: blue; }
  .status.delivered { color: green; }
  .timeline { border-left: 3px solid #ccc; padding-left: 20px; margin-top: 15px; }
  .timeline-item { margin-bottom: 15px; position: relative; padding-left: 10px; }
  .timeline-item::before { content: ''; position: absolute; left: -10px; top: 0; width: 15px; height: 15px; border-radius: 50%; background-color: gray; }
  .timeline-item.pending::before { background-color: orange; }
  .timeline-item.in-transit::before { background-color: blue; }
  .timeline-item.delivered::before { background-color: green; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  button { cursor: pointer; background-color: #004080; color: #fff; border: none; border-radius: 4px; padding: 10px; margin-top: 10px; }
  #countdown { font-size: 14px; font-weight: bold; margin-top: 10px; }
</style>
</head>
<body>

<header>
  <h1>SLNSA - Shipment Tracking</h1>
  <nav>
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="services.html">Services</a>
    <a href="contact.html">Contact</a>
    <a href="track.html">Track</a>
  </nav>
</header>

<main>
  <section class="tracking-form">
    <h2>Enter Tracking Information</h2>
    <form id="trackForm">
      <input type="text" id="trackingNumber" placeholder="Tracking Number" required>
      <input type="text" id="locationInput" placeholder="Current Location" required>
      <select id="statusInput" required>
        <option value="">Select Status</option>
        <option value="Pending">Pending</option>
        <option value="In-Transit">In-Transit</option>
        <option value="Delivered">Delivered</option>
      </select>
      <button type="submit">Save & Track Shipment</button>
    </form>
  </section>

  <section class="tracking-result" id="trackingResult">
    <h2>Tracking Details</h2>
    <p><strong>Tracking Number:</strong> <span id="resultNumber"></span></p>
    <p><strong>Status:</strong> <span id="resultStatus" class="status"></span></p>
    <p><strong>Origin:</strong> Freetown Port</p>
    <p><strong>Destination:</strong> International Port</p>
    <p><strong>Estimated Delivery:</strong> <span id="estimatedDate"></span></p>
    <p id="countdown"></p>

    <h3>Shipment Timeline</h3>
    <div id="timeline" class="timeline"></div>

    <h3>Shipment History Table</h3>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Location</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>

    <button id="downloadBtn">Download PDF</button>
    <button id="downloadCSV">Download CSV</button>
  </section>
</main>

<footer>
  <p>Â© 2025 SLNSA | Address: 5 Naimbana Street, Freetown | Email: info@slnsa.com.sl | Phone: +232 76 747 893</p>
</footer>

<script src="assets/js/main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const trackForm = document.getElementById('trackForm');
const trackingResult = document.getElementById('trackingResult');
const resultNumber = document.getElementById('resultNumber');
const resultStatus = document.getElementById('resultStatus');
const estimatedDate = document.getElementById('estimatedDate');
const historyTable = document.getElementById('historyTable');
const timelineEl = document.getElementById('timeline');
const countdownEl = document.getElementById('countdown');
const downloadBtn = document.getElementById('downloadBtn');
const downloadCSVBtn = document.getElementById('downloadCSV');

let historyData = [];

// Backend API base URL
const API_BASE = 'https://your-backend-domain.com'; // replace with your deployed backend

trackForm.addEventListener('submit', async function(e){
  e.preventDefault();
  const trackingNumber = document.getElementById('trackingNumber').value.trim();
  const locationInput = document.getElementById('locationInput').value.trim();
  const statusInput = document.getElementById('statusInput').value.trim();

  if(!trackingNumber || !locationInput || !statusInput) return alert("Please fill all fields.");

  try {
    const response = await fetch(`${API_BASE}/api/track`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trackingNumber, location: locationInput, status: statusInput })
    });
    const data = await response.json();
    historyData = data.history;
    displayTrackingResult(historyData, trackingNumber);
  } catch(err) {
    alert("Error saving shipment data: " + err.message);
  }
});

async function fetchShipmentHistory(trackingNumber){
  try {
    const response = await fetch(`${API_BASE}/api/track/${trackingNumber}`);
    const data = await response.json();
    historyData = data.history;
    displayTrackingResult(historyData, trackingNumber);
  } catch(err){
    alert("Error fetching shipment history: " + err.message);
  }
}

function displayTrackingResult(historyData, trackingNumber){
  resultNumber.textContent = trackingNumber;
  const latestStatus = historyData[historyData.length-1].status;
  resultStatus.textContent = latestStatus;
  resultStatus.className = 'status ' + latestStatus.toLowerCase().replace(' ','-');

  // Estimated delivery
  const lastDate = new Date(historyData[historyData.length-1].date);
  const estDate = new Date(lastDate);
  estDate.setDate(lastDate.getDate()+5);
  estimatedDate.textContent = estDate.toLocaleDateString();

  // Timeline
  timelineEl.innerHTML='';
  historyData.forEach(item=>{
    const div=document.createElement('div');
    div.className=`timeline-item ${item.status.toLowerCase().replace(' ','-')}`;
    div.innerHTML=`<strong>${new Date(item.date).toLocaleDateString()}</strong> - ${item.location} : ${item.status}`;
    timelineEl.appendChild(div);
  });

  // Table
  historyTable.innerHTML='';
  historyData.forEach(item=>{
    const row=document.createElement('tr');
    row.innerHTML=`<td>${new Date(item.date).toLocaleDateString()}</td><td>${item.location}</td><td class="status ${item.status.toLowerCase().replace(' ','-')}">${item.status}</td>`;
    historyTable.appendChild(row);
  });

  startCountdown(estDate);
  trackingResult.style.display='block';
  trackingResult.scrollIntoView({behavior:'smooth'});
}

// Countdown
function startCountdown(estDate){
  clearInterval(window.countdownInterval);
  window.countdownInterval=setInterval(()=>{
    const now=new Date().getTime();
    const distance=estDate-now;
    if(distance<0){ countdownEl.textContent="Shipment Delivered"; clearInterval(window.countdownInterval); return; }
    const days=Math.floor(distance/(1000*60*60*24));
    const hours=Math.floor((distance/(1000*60*60))%24);
    const minutes=Math.floor((distance/(1000*60))%60);
    countdownEl.textContent=`Estimated Delivery: ${days}d ${hours}h ${minutes}m`;
  },1000);
}

// CSV download
downloadCSVBtn.addEventListener('click',()=>{
  if(historyData.length===0) return alert("No data to download.");
  let csv="Date,Location,Status\n";
  historyData.forEach(item=>{ csv+=`${new Date(item.date).toLocaleDateString()},${item.location},${item.status}\n`; });
  const blob=new Blob([csv],{type:'text/csv'});
  const link=document.createElement('a');
  link.href=URL.createObjectURL(blob);
  link.download=`${resultNumber.textContent}_history.csv`;
  link.click();
});

// PDF download
downloadBtn.addEventListener('click',()=>{
  if(historyData.length===0) return alert("No data to download.");
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let currentY=20;

  const logo = new Image();
  logo.src='assets/images/logo.png';
  logo.onload=function(){
    doc.addImage(logo,'PNG',20,5,30,30);
    doc.setFontSize(18);
    doc.text("SLNSA",60,15);
    doc.setFontSize(12);
    doc.text("Shipment Tracking Details",60,22);

    currentY+=35;
    doc.text(`Tracking Number: ${resultNumber.textContent}`,20,currentY);
    doc.text(`Status: ${resultStatus.textContent}`,20,currentY+7);
    doc.text(`Origin: Freetown Port`,20,currentY+14);
    doc.text(`Destination: International Port`,20,currentY+21);
    doc.text(`Estimated Delivery: ${estimatedDate.textContent}`,20,currentY+28);

    currentY+=40;
    doc.text("Shipment History:",20,currentY);
    currentY+=7;
    historyData.forEach((item,index)=>{
      doc.text(`${new Date(item.date).toLocaleDateString()} | ${item.location} | ${item.status}`,20,currentY + index*7);
    });

    doc.setFontSize(10);
    doc.text("Address: 5 Naimbana Street | Email: info@slnsa.com.sl | Phone: +232 76 747 893",20,280);

    doc.save(`${resultNumber.textContent}_tracking.pdf`);
  }
});
</script>

</body>
</html>